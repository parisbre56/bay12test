<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>ER Character Calculator</title>
	<link rel="shortcut icon" href="http://parisbre56-phpexperiment.rhcloud.com/favicon.ico"/>
	<style>
		table, th, td {
		    border: 1px solid black;
		}
	</style>
</head> 

<body>

<noscript><p style="color: red; font-size:30px">Sorry, your browser does not support JavaScript!</p></noscript>
<script type="text/javascript">
  "use strict";
  
  //Simple function to compute the sign
  function sign(x) {
    return typeof x === 'number' ? x ? x < 0 ? -1 : 1 : x === x ? 0 : NaN : NaN;
  }

  //Returns the triangular number sequence (...,-3,-1,0,1,3,6,10,...)
  function triSeq(I) {
    return sign(I)*(Math.abs(I)+1)*Math.abs(I)/2;
  }

  //Returns the points needed for the skill level given
  function getPDelta(I) {
    return sign(I)*(Math.abs(I)+1)*Math.abs(I)*2.5; // 5/2=2.5
  }

  //Returns the total skill level based on points allocated and initial skill level
  function computeSkillLevel(P,I) { //P is points in skill, I is initial level of skill
    var PDelta = getPDelta(I);
    if(P+PDelta < 0) {
      return -Math.ceil(-0.5 + Math.sqrt(5 + 8*Math.abs(PDelta+P))/4.472135955); //2*sqrt(5)
    } else {
      return Math.floor((-0.5 + Math.sqrt(5 + 8*Math.abs(PDelta+P))/4.472135955)+ 0.00001);
    }
  }
  
  //Updates a stat on change of its inputs
  function updateStat(P, I, T, L, R) { //T is total, L is points left until next level, R is extra points for enhancement or similar
    var PN = parseInt(document.getElementById(P).value); //Points
    var IN = parseInt(document.getElementById(I).value); //Initial level
    var TE = document.getElementById(T); //Total skill (element for output)
    var LE = document.getElementById(L); //Points left for next level (element for output)
    var RC = parseInt(document.getElementById(R).value); //Is the stat enhanced?
    var SkillLevel=computeSkillLevel(PN,IN);
    TE.innerHTML=(SkillLevel+RC).toString(); //Write total skill level
    
    //Write points left for next level
    //It is the ([the points needed for the next level]-[the points needed for this level])-
    //([current points]-([the points needed for this level] - [the points needed for the initial skill level]))
    LE.innerHTML=(getPDelta(SkillLevel+1)-getPDelta(SkillLevel))-(PN-(getPDelta(SkillLevel)-getPDelta(IN)));
  }
  
  //Notifies the user of any problem with their skill levels by changing a textbox in the end
  function writeInitialLevelStatProblems (S, D, E, C, M, F, I) {
    //Strength, Dexterity, Endurance, Charisma, Mind, Fate, Intuition
    //<p style="color: red; font-size:30px"><output id="StatErrorText"></output></p>
    //Total positive initial levels: <output id="PositiveStatLevels">0</output><br>
    //Total negative initial levels: <output id="NegativeStatLevels">0</output> <output id="NegativeStatLevelDelta"></output><br>
    //Total negative initial levels needed: <output id="NegativeStatLevelsNeeded">0</output><br>
    
    //for all arguments, find the total positive and negative levels
    var temp=0;
    var totalNegative=0;
    var totalPositive=0;
    var overLimitPositiveDetected=false;
    var overLimitNegativeDetected=false;
	var bonusPlus = false;
    for (var i=0; i < arguments.length; i++) {
        temp=parseInt(document.getElementById(arguments[i]).value);
        if(temp<0) {
          totalNegative+=temp;
          if(temp<-2) {
            overLimitNegativeDetected=true;
          }
        } else {
		  if(temp>0 && !bonusPlus && totalPositive>0){
			bonusPlus = true;
			totalPositive-=1;
		  }
          totalPositive+=temp;
          if(temp>2) {
            overLimitPositiveDetected=true;
          }
        }
    }
    //Find the negative levels needed for the positive levels given
    var negativeNeeded=-triSeq(totalPositive);
    if(bonusPlus){
		negativeNeeded-= 1;
		totalPositive += 1;
	}
	
    //Display error
    if(overLimitNegativeDetected) {
      document.getElementById("StatErrorText").innerHTML="Initial stat levels can't be less than -2";
    }
    else if(overLimitPositiveDetected) {
      document.getElementById("StatErrorText").innerHTML="Initial stat levels can't be more than 2";
    }
    else {
      document.getElementById("StatErrorText").innerHTML="";
    }
    
    //Display statistics 
    document.getElementById("PositiveStatLevels").innerHTML=totalPositive;
    document.getElementById("NegativeStatLevels").innerHTML=totalNegative;
    if(negativeNeeded-totalNegative<0) { //-5-(-3)=-2 more levels needed
      document.getElementById("NegativeStatLevelDelta").innerHTML="("+Math.abs(negativeNeeded-totalNegative).toString()+" more negative levels needed)";
    }
    else if(negativeNeeded-totalNegative>0) { //-5-(-7)=2 more negative levels than necessary
      document.getElementById("NegativeStatLevelDelta").innerHTML="("+Math.abs(negativeNeeded-totalNegative).toString()+" more negative levels than necessary)";
    }
    else { //if equal, say nothing
      document.getElementById("NegativeStatLevelDelta").innerHTML="";
    }
    document.getElementById("NegativeStatLevelsNeeded").innerHTML=negativeNeeded;
  }
  
  //Notifies the user of any problem with their stat levels by changing a textbox in the end
  function writeInitialLevelSkillProblems (H, C, U, E, A, M, G) {
    //Handiwork, Conventional, Unconventional, Exotic, Auxilliary, Medical, Gen.Knowledge
    
    //for all arguments, find the total positive and negative levels
    var temp=0;
    var totalNegative=0;
    var totalPositive=0;
    var overLimitPositiveDetected=false;
    var overLimitNegativeDetected=false;
	var bonusPlus = false;
    for (var i=0; i < arguments.length; i++) {
        temp=parseInt(document.getElementById(arguments[i]).value);
        if(temp<0) {
          totalNegative+=temp;
          if(temp<-2) {
            overLimitNegativeDetected=true;
          }
        } else {
		  if(temp>0 && !bonusPlus && totalPositive>0){
			bonusPlus = true;
			totalPositive-=1;
		  }
          totalPositive+=temp;
          if(temp>2) {
            overLimitPositiveDetected=true;
          }
        }
    }
    //Find the negative levels needed for the positive levels given
    var negativeNeeded=-triSeq(totalPositive);
	if(bonusPlus){
		negativeNeeded-= 1;
		totalPositive += 1;
	}
    
    //Display error
    if(overLimitNegativeDetected) {
      document.getElementById("SkillErrorText").innerHTML="Initial Skill levels can't be less than -2";
    }
    else if(overLimitPositiveDetected) {
      document.getElementById("SkillErrorText").innerHTML="Initial Skill levels can't be more than 2";
    }
    else {
      document.getElementById("SkillErrorText").innerHTML="";
    }
    
    //Display Skillistics 
    document.getElementById("PositiveSkillLevels").innerHTML=totalPositive;
    document.getElementById("NegativeSkillLevels").innerHTML=totalNegative;
    if(negativeNeeded-totalNegative<0) { //-5-(-3)=-2 more levels needed
      document.getElementById("NegativeSkillLevelDelta").innerHTML="("+Math.abs(negativeNeeded-totalNegative).toString()+" more negative levels needed)";
    }
    else if(negativeNeeded-totalNegative>0) { //-5-(-7)=2 more negative levels than necessary
      document.getElementById("NegativeSkillLevelDelta").innerHTML="("+Math.abs(negativeNeeded-totalNegative).toString()+" more negative levels than necessary)";
    }
    else { //if equal, say nothing
      document.getElementById("NegativeSkillLevelDelta").innerHTML="";
    }
    document.getElementById("NegativeSkillLevelsNeeded").innerHTML=negativeNeeded;
  }
  
  //Compute stat point total and mission total and write them in a text box in the end
  function writeStatPointProblems (S, D, E, C, M, F, I) {
    //Strength, Dexterity, Endurance, Charisma, Mind, Fate, Intuition
    //<p style="color: red; font-size:30px"><output id="StatErrorText"></output></p>
    //Point total: <output id="TotalStatPoints">0</output> 
    //(<output id="StatMissions">0</output> Mission(s), <output id="StatExtra">0</output> extra points)<br>
    
    var temp=0;
    var total=0;
    var negativeDetected=false;
    //Get the total points
    for (var i=0; i < arguments.length; i++) {
      temp=parseInt(document.getElementById(arguments[i]).value);
      total+=temp;
      if(temp<0) {
        negativeDetected=true;
      }
    }
    
    //Print error
    if(negativeDetected) {
      document.getElementById("StatErrorText").innerHTML="Stat points can't be negative";
    }
    
    //Print statistics
    document.getElementById("TotalStatPoints").innerHTML=total.toString();
    document.getElementById("StatMissions").innerHTML=Math.floor(total/5).toString();
    document.getElementById("StatExtra").innerHTML=(total%5).toString();
  }
  
  //Compute skill point total and mission total and write them in a text box in the end
  function writeSkillPointProblems (H, C, U, E, A, M, G) {
    //Handiwork, Conventional, Unconventional, Exotic, Auxilliary, Medical, Gen.Knowledge
    
    var temp=0;
    var total=0;
    var negativeDetected=false;
    //Get the total points
    for (var i=0; i < arguments.length; i++) {
      temp=parseInt(document.getElementById(arguments[i]).value);
      total+=temp;
      if(temp<0) {
        negativeDetected=true;
      }
    }
    
    //Print error
    if(negativeDetected) {
      document.getElementById("SkillErrorText").innerHTML="Skill points can't be negative";
    }
    
    //Print Skillistics
    document.getElementById("TotalSkillPoints").innerHTML=total.toString();
    document.getElementById("SkillMissions").innerHTML=Math.floor(total/5).toString();
    document.getElementById("SkillExtra").innerHTML=(total%5).toString();
    
  }
  
  function refreshTables() {
    writeInitialLevelStatProblems('StrI','DexI','EndI','ChaI','MindI','FateI','IntuI');
    writeStatPointProblems('StrP','DexP','EndP','ChaP','MindP','FateP','IntuP');
    
    updateStat('StrP','StrI','StrT','StrL','StrR');
    updateStat('DexP','DexI','DexT','DexL','DexR');
    updateStat('EndP','EndI','EndT','EndL','EndR');
    updateStat('ChaP','ChaI','ChaT','ChaL','ChaR');
    updateStat('MindP','MindI','MindT','MindL','MindR');
    updateStat('FateP','FateI','FateT','FateL','FateR');
    updateStat('IntuP','IntuI','IntuT','IntuL','IntuR');
    
    writeInitialLevelSkillProblems('HanI','ConI','UnconI','ExoI','AuxI','MedI','GenI');
    writeSkillPointProblems('HanP','ConP','UnconP','ExoP','AuxP','MedP','GenP');
    
    updateStat('HanP','HanI','HanT','HanL','HanR');
    updateStat('ConP','ConI','ConT','ConL','ConR');
    updateStat('UnconP','UnconI','UnconT','UnconL','UnconR');
    updateStat('ExoP','ExoI','ExoT','ExoL','ExoR');
    updateStat('AuxP','AuxI','AuxT','AuxL','AuxR');
    updateStat('MedP','MedI','MedT','MedL','MedR');
    updateStat('GenP','GenI','GenT','GenL','GenR');
  }
  
  window.onload = refreshTables;
</script>

<h1>Stat and Skill Rules</h1>
<h3>Character creation</h3>
<ul>
  <li>Everyone starts with zero levels and zero points in all stats and skills.</li>
  <li>You can add positive levels during character creation, but must take a greater penalty each time you do so. These are reffered to as 'Initial levels' in this page.
  <ul>
    <li>Having a <em>total</em> of +1 positive intial levels means you must take a total of -1 negative intial levels.</li>
    <li>Having a <em>total</em> of +2 positive intial levels means you must take a total of -3 negative intial levels.</li>
    <li>Having a <em>total</em> of +3 positive intial levels means you must take a total of -6 negative intial levels.</li>
    <li>Having a <em>total</em> of +4 positive intial levels means you must take a total of -10 negative intial levels.</li>
    <li>Note that the total is different between stats and skills. <br>You cannot mix the total initial levels for stats with the total initial levels for skills. <br>You <strong>cannot</strong> have +1 strength and +1 willpower for -2 endurance and -1 conventional.</li>
  </ul></li>
  <li>Your second increase to 1 can be taken at a cost of -1
  <ul>
    <li>This +1 does not count toward the cummulative total</li>
	<li>This 1 *can* be increased, using the normal system</li>
  </ul></li>
  <li>You can not have an initial level lower than -2.</li>
  <li><strong>Only</strong> during character generation, you cannot have an initial level greater than 2.</li>
</ul>
<h3>Level up</h3>
<ul>
  <li>You get 5 points for stats and 5 for skills at the end of each mission.
  <ul>
    <li>Getting from level -2 to level -1 takes 10 points.</li>
    <li>Getting from level -1 to level 0 takes 5 points.</li>
    <li>Getting from level 0 to level 1 takes 5 points.</li>
    <li>Getting from level 1 to level 2 takes 10 points.</li>
    <li>Getting from level 2 to level 3 takes 15 points.</li>
    <li>Getting from level 3 to level 4 takes 20. <br>To get to level 4 from level 0, in other words, you'd need to spend 50 points, or 10 missions worth. <br>On the other hand, if you have an initial level of 2 on a skill, you can reach level 4 with just 35 points or 7 missions worth.</li>
  </ul></li>
  <li>Note that special circumstances (brain damage, genemods, alien parasites, Doctor experimentation, etc.) may change the number of points given or may result in point deduction.</li>
  <li>Enhanced Capacity upgrades are addons that can be bought from the armoury and can give you a +1 to <strong>either</strong> 1 stat or 1 skill. You can have only one of them installed at a time.</li>
</ul>

<h3>Extra rules for old characters</h3>
<ul>
  <li>The Anompalous Planetoid mission counts as two missions and thus gives two levelups instead of one.</li>
  <li>Those that got points during the Hephaestus timeskip get 5 extra points to put in <strong>either</strong> stats or skills or a combination of the two. <br>That means that they can put 2 points in strength and 3 points in intuition, for example.</li>
  <li>Those that participated in the Hephaestus space battle get 5 extra points to put in <strong>either</strong> stats or skills or a combination of the two. <br>That means that they can put 2 points in strength and 3 points in intuition, for example.</li>
  <li>Lars gets a +1 level to Fate without the need to take extra negative levels for it.</li>
</ul>

<h2>Stats</h2>
<table oninput="refreshTables();">
  <tr>
    <td><strong>Name</strong></td>
    <td><strong>Points assigned</strong></td>
    <td><strong>Initial level</strong></td>
    <td><strong>Total level</strong></td>
    <td><strong>Points left for next level</strong></td>
    <td><strong>Enhanced Capacity</strong></td>
  </tr>
  <tr>
      <td>Strength</td>
      <td><input type="number" id="StrP" value="0"></td>
      <td><input type="number" id="StrI" value="0"></td>
      <td><output id="StrT">0</output></td>
      <td><output id="StrL">5</output></td>
      <td><input type="number" id="StrR" value="0"></td>
  </tr>
  <tr>
      <td>Dexterity</td>
      <td><input type="number" id="DexP" value="0"></td>
      <td><input type="number" id="DexI" value="0"></td>
      <td><output id="DexT">0</output></td>
      <td><output id="DexL">5</output></td>
      <td><input type="number" id="DexR" value="0"></td>
  </tr>
  <tr>
      <td>Endurance</td>
      <td><input type="number" id="EndP" value="0"></td>
      <td><input type="number" id="EndI" value="0"></td>
      <td><output id="EndT">0</output></td>
      <td><output id="EndL">5</output></td>
      <td><input type="number" id="EndR" value="0"></td>
  </tr>
  <tr>
      <td>Charisma</td>
      <td><input type="number" id="ChaP" value="0"></td>
      <td><input type="number" id="ChaI" value="0"></td>
      <td><output id="ChaT">0</output></td>
      <td><output id="ChaL">5</output></td>
      <td><input type="number" id="ChaR" value="0"></td>
  </tr>
  <tr>
      <td>Mind</td>
      <td><input type="number" id="MindP" value="0"></td>
      <td><input type="number" id="MindI" value="0"></td>
      <td><output id="MindT">0</output></td>
      <td><output id="MindL">5</output></td>
      <td><input type="number" id="MindR" value="0"></td>
  </tr>
  <!-- Deprecated Int and Will stats
  <tr oninput="updateStat('IntelP','IntelI','IntelT','IntelL');">
      <td>Intelligence</td>
      <td><input type="number" id="IntelP" value="0"></td>
      <td><input type="number" id="IntelI" value="0"></td>
      <td><output id="IntelT">0</output></td>
      <td><output id="IntelL">5</output></td>
  </tr>
  <tr oninput="updateStat('WillP','WillI','WillT','WillL');">
      <td>Willlpower</td>
      <td><input type="number" id="WillP" value="0"></td>
      <td><input type="number" id="WillI" value="0"></td>
      <td><output id="WillT">0</output></td>
      <td><output id="WillL">5</output></td>
  </tr>
	-->
  <tr>
      <td>Fate</td>
      <td><input type="number" id="FateP" value="0"></td>
      <td><input type="number" id="FateI" value="0"></td>
      <td><output id="FateT">0</output></td>
      <td><output id="FateL">5</output></td>
      <td><input type="number" id="FateR" value="0"></td>
  </tr>
  <tr>
      <td>Intuition</td>
      <td><input type="number" id="IntuP" value="0"></td>
      <td><input type="number" id="IntuI" value="0"></td>
      <td><output id="IntuT">0</output></td>
      <td><output id="IntuL">5</output></td>
      <td><input type="number" id="IntuR" value="0"></td>
  </tr>
</table>

<br>
<p style="color: red; font-size:30px"><output id="StatErrorText"></output></p>
<p>
  Total positive initial levels: <output id="PositiveStatLevels">0</output><br>
  Total negative initial levels: <output id="NegativeStatLevels">0</output>  <output id="NegativeStatLevelDelta"></output><br>
  Total negative initial levels needed: <output id="NegativeStatLevelsNeeded">0</output><br>
  Point total: <output id="TotalStatPoints">0</output> (<output id="StatMissions">0</output> Mission(s), <output id="StatExtra">0</output> extra points)<br>
</p>

<h2>Skills</h2>
<table oninput="refreshTables();">
  <tr>
    <td><strong>Name</strong></td>
    <td><strong>Points assigned</strong></td>
    <td><strong>Initial level</strong></td>
    <td><strong>Total level</strong></td>
    <td><strong>Left for next level</strong></td>
    <td><strong>Enhanced Capacity</strong></td>
  </tr>
  <tr>
      <td>Handiwork</td>
      <td><input type="number" id="HanP" value="0"></td>
      <td><input type="number" id="HanI" value="0"></td>
      <td><output id="HanT">0</output></td>
      <td><output id="HanL">5</output></td>
      <td><input type="number" id="HanR" value="0"></td>
  </tr>
  <tr>
      <td>Conventional</td>
      <td><input type="number" id="ConP" value="0"></td>
      <td><input type="number" id="ConI" value="0"></td>
      <td><output id="ConT">0</output></td>
      <td><output id="ConL">5</output></td>
      <td><input type="number" id="ConR" value="0"></td>
  </tr>
  <tr>
      <td>Unconventional</td>
      <td><input type="number" id="UnconP" value="0"></td>
      <td><input type="number" id="UnconI" value="0"></td>
      <td><output id="UnconT">0</output></td>
      <td><output id="UnconL">5</output></td>
      <td><input type="number" id="UnconR" value="0"></td>
  </tr>
  <tr>
      <td>Exotic</td>
      <td><input type="number" id="ExoP" value="0"></td>
      <td><input type="number" id="ExoI" value="0"></td>
      <td><output id="ExoT">0</output></td>
      <td><output id="ExoL">5</output></td>
      <td><input type="number" id="ExoR" value="0"></td>
  </tr>
  <tr>
      <td>Auxiliary</td>
      <td><input type="number" id="AuxP" value="0"></td>
      <td><input type="number" id="AuxI" value="0"></td>
      <td><output id="AuxT">0</output></td>
      <td><output id="AuxL">5</output></td>
      <td><input type="number" id="AuxR" value="0"></td>
  </tr>
  <tr>
      <td>Medical</td>
      <td><input type="number" id="MedP" value="0"></td>
      <td><input type="number" id="MedI" value="0"></td>
      <td><output id="MedT">0</output></td>
      <td><output id="MedL">5</output></td>
      <td><input type="number" id="MedR" value="0"></td>
  </tr>
  <tr>
      <td>Gen. Knowledge</td>
      <td><input type="number" id="GenP" value="0"></td>
      <td><input type="number" id="GenI" value="0"></td>
      <td><output id="GenT">0</output></td>
      <td><output id="GenL">5</output></td>
      <td><input type="number" id="GenR" value="0"></td>
  </tr>
</table>

<p style="color: red; font-size:30px"><output id="SkillErrorText"></output></p>
<p>
  Total positive initial levels: <output id="PositiveSkillLevels">0</output><br>
  Total negative initial levels: <output id="NegativeSkillLevels">0</output>  <output id="NegativeSkillLevelDelta"></output><br>
  Total negative initial levels needed: <output id="NegativeSkillLevelsNeeded">0</output><br>
  Point total: <output id="TotalSkillPoints">0</output> (<output id="SkillMissions">0</output> Mission(s), <output id="SkillExtra">0</output> extra points)<br>
</p>

</body>
</html>
